package abi

import (
	"context"
	"github.com/stretchr/testify/assert"
	"github.com/taorzhang/toolkit/abi"
	"github.com/taorzhang/toolkit/client"
	"github.com/taorzhang/toolkit/client/jsonrpc"
	"github.com/taorzhang/toolkit/types/block"
	"math/big"
	"testing"
)

func initProvider(t *testing.T) client.Provider {
	opts := jsonrpc.GetDefaultOpts("https://arbitrum-mainnet.token.im")
	opts = append(opts, jsonrpc.WithRpcHeaders(map[string]string{
		"deviceToken": "test1234",
	}))
	c, err := jsonrpc.NewClient(opts...)
	assert.NoError(t, err)
	return client.NewEthClient(c, nil)
}

func TestABI_Event(t *testing.T) {
	ab, err := abi.NewABIFromList([]string{
		"event TransferBatch(address indexed operator, address indexed from, address indexed to, uint256[] ids, uint256[] values)",
	})
	assert.NoError(t, err)
	event := ab.GetEventByID("0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb")
	assert.NotNil(t, event)
	t.Log("id", event.ID())

	provider := initProvider(t)
	transaction, err := provider.TransactionByHash(context.Background(), block.Hex2Hash("0x00000C558A0C8D80A2DE98B3D634FDAA6ECF9DF686B4157F090DA28D4D19E85E"), true)
	assert.NoError(t, err)
	log := transaction.Receipt.Logs[1]
	t.Log("idx", transaction.Hash)
	t.Log("log", log)

	parsedData, err := event.ParseLog(log)
	assert.NoError(t, err)
	t.Log("parsed result", parsedData)

}

func TestABI_2(t *testing.T) {
	newInt := big.NewInt(64)
	t.Log("len", newInt.BitLen())
}

func TestABI_3(t *testing.T) {
	method, err := abi.NewMethod("function transfer(address dst, uint256 wad)")
	assert.NoError(t, err)
	t.Log("method", string(method.HexID()))
}

func TestABI_encode1(t *testing.T) {
	ab, err := abi.NewABIFromList([]string{
		"function echo(address from, address to, string words) public returns(string)",
	})
	assert.NoError(t, err)
	method := ab.GetMethodByID("0xc62969e0")
	encode, err := method.Encode([]interface{}{"0x4a2328fd4790f0950ddaf2f8a369786f094a1299", "0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45", "hello world! Nick!"})
	assert.NoError(t, err)
	var h block.Hex
	err = h.ToHex(encode)
	assert.NoError(t, err)
	t.Log("encode:", h.String())
}

// TestABI_transfer_method 构造input
// https://goerli.etherscan.io/tx/0x669cd6d0afc326785e668ad207b43007be678d05bab5d6d13b240b1379af79f0
func TestABI_transfer_method(t *testing.T) {
	method, err := abi.NewMethod("function transfer(address dst, uint256 wad)")
	assert.NoError(t, err)
	t.Log("sig:", method.Sig())
	t.Log("id:", block.Hex(method.ID()).Hex())
	encode, err := method.Encode([]interface{}{"0x7a64BE40B9f2412FBaDeB519B2d119eC59D8e0CD", "1000000000000000000000"})
	assert.NoError(t, err)
	t.Log("encode", block.Hex(encode).Hex())
	assert.Equal(t,
		"0xa9059cbb0000000000000000000000007a64be40b9f2412fbadeb519b2d119ec59d8e0cd00000000000000000000000000000000000000000000003635c9adc5dea00000",
		block.Hex(encode).Hex())
}

const (
	AllPariVaultAbi = `[{"inputs":[{"internalType":"address","name":"_registry","type":"address"},{"internalType":"address","name":"_trancheTokenImpl","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"trancheId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"excess","type":"uint256"}],"name":"Claimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":true,"internalType":"contract IERC20","name":"seniorAsset","type":"address"},{"indexed":true,"internalType":"contract IERC20","name":"juniorAsset","type":"address"},{"indexed":false,"internalType":"contract ITrancheToken","name":"seniorToken","type":"address"},{"indexed":false,"internalType":"contract ITrancheToken","name":"juniorToken","type":"address"}],"name":"CreatedPair","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"trancheId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorTrancheMintedAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorTrancheMintedAmount","type":"uint256"}],"name":"DepositedLP","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorAmount","type":"uint256"}],"name":"Invested","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorReceived","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorReceived","type":"uint256"}],"name":"Redeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"rollover","type":"address"},{"indexed":true,"internalType":"uint256","name":"rolloverId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorAmount","type":"uint256"}],"name":"RolloverClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"rollover","type":"address"},{"indexed":true,"internalType":"uint256","name":"rolloverId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorAmount","type":"uint256"}],"name":"RolloverDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"rollover","type":"address"},{"indexed":true,"internalType":"uint256","name":"rolloverId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"}],"name":"SetRollover","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"trancheId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"burnedAmount","type":"uint256"}],"name":"Withdrew","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":true,"internalType":"uint256","name":"vaultId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seniorTrancheBurnedAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"juniorTrancheBurnedAmount","type":"uint256"}],"name":"WithdrewLP","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"VaultsByTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"}],"name":"canDeposit","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"claim","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"claimETH","outputs":[{"internalType":"uint256","name":"invested","type":"uint256"},{"internalType":"uint256","name":"excess","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"address","name":"seniorAsset","type":"address"},{"internalType":"address","name":"juniorAsset","type":"address"},{"internalType":"address","name":"strategist","type":"address"},{"internalType":"address","name":"strategy","type":"address"},{"internalType":"uint256","name":"hurdleRate","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"enrollment","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"string","name":"seniorName","type":"string"},{"internalType":"string","name":"seniorSym","type":"string"},{"internalType":"string","name":"juniorName","type":"string"},{"internalType":"string","name":"juniorSym","type":"string"},{"internalType":"uint256","name":"seniorTrancheCap","type":"uint256"},{"internalType":"uint256","name":"seniorUserCap","type":"uint256"},{"internalType":"uint256","name":"juniorTrancheCap","type":"uint256"},{"internalType":"uint256","name":"juniorUserCap","type":"uint256"}],"internalType":"struct OLib.VaultParams","name":"_params","type":"tuple"}],"name":"createVault","outputs":[{"internalType":"uint256","name":"vaultId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"denominator","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"depositETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_rolloverId","type":"uint256"},{"internalType":"uint256","name":"_seniorAmount","type":"uint256"},{"internalType":"uint256","name":"_juniorAmount","type":"uint256"}],"name":"depositFromRollover","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_lpTokens","type":"uint256"}],"name":"depositLp","outputs":[{"internalType":"uint256","name":"seniorTokensOwed","type":"uint256"},{"internalType":"uint256","name":"juniorTokensOwed","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"target","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"excall","outputs":[{"internalType":"bytes","name":"returnData","type":"bytes"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_lpTokens","type":"uint256"}],"name":"getDepositLp","outputs":[{"internalType":"uint256","name":"seniorTokensOwed","type":"uint256"},{"internalType":"uint256","name":"juniorTokensOwed","type":"uint256"},{"internalType":"contract IERC20","name":"pool","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"}],"name":"getState","outputs":[{"internalType":"enum OLib.State","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"}],"name":"getVaultById","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"components":[{"internalType":"contract IERC20","name":"token","type":"address"},{"internalType":"contract ITrancheToken","name":"trancheToken","type":"address"},{"internalType":"uint256","name":"trancheCap","type":"uint256"},{"internalType":"uint256","name":"userCap","type":"uint256"},{"internalType":"uint256","name":"deposited","type":"uint256"},{"internalType":"uint256","name":"originalInvested","type":"uint256"},{"internalType":"uint256","name":"totalInvested","type":"uint256"},{"internalType":"uint256","name":"received","type":"uint256"},{"internalType":"uint256","name":"rolloverDeposited","type":"uint256"}],"internalType":"struct IPairVault.Asset[]","name":"assets","type":"tuple[]"},{"internalType":"contract IStrategy","name":"strategy","type":"address"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"strategist","type":"address"},{"internalType":"address","name":"rollover","type":"address"},{"internalType":"uint256","name":"hurdleRate","type":"uint256"},{"internalType":"enum OLib.State","name":"state","type":"uint8"},{"internalType":"uint256","name":"startAt","type":"uint256"},{"internalType":"uint256","name":"investAt","type":"uint256"},{"internalType":"uint256","name":"redeemAt","type":"uint256"}],"internalType":"struct IPairVault.VaultView","name":"vault","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_trancheToken","type":"address"}],"name":"getVaultByToken","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"components":[{"internalType":"contract IERC20","name":"token","type":"address"},{"internalType":"contract ITrancheToken","name":"trancheToken","type":"address"},{"internalType":"uint256","name":"trancheCap","type":"uint256"},{"internalType":"uint256","name":"userCap","type":"uint256"},{"internalType":"uint256","name":"deposited","type":"uint256"},{"internalType":"uint256","name":"originalInvested","type":"uint256"},{"internalType":"uint256","name":"totalInvested","type":"uint256"},{"internalType":"uint256","name":"received","type":"uint256"},{"internalType":"uint256","name":"rolloverDeposited","type":"uint256"}],"internalType":"struct IPairVault.Asset[]","name":"assets","type":"tuple[]"},{"internalType":"contract IStrategy","name":"strategy","type":"address"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"strategist","type":"address"},{"internalType":"address","name":"rollover","type":"address"},{"internalType":"uint256","name":"hurdleRate","type":"uint256"},{"internalType":"enum OLib.State","name":"state","type":"uint8"},{"internalType":"uint256","name":"startAt","type":"uint256"},{"internalType":"uint256","name":"investAt","type":"uint256"},{"internalType":"uint256","name":"redeemAt","type":"uint256"}],"internalType":"struct IPairVault.VaultView","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_from","type":"uint256"},{"internalType":"uint256","name":"_to","type":"uint256"}],"name":"getVaults","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"components":[{"internalType":"contract IERC20","name":"token","type":"address"},{"internalType":"contract ITrancheToken","name":"trancheToken","type":"address"},{"internalType":"uint256","name":"trancheCap","type":"uint256"},{"internalType":"uint256","name":"userCap","type":"uint256"},{"internalType":"uint256","name":"deposited","type":"uint256"},{"internalType":"uint256","name":"originalInvested","type":"uint256"},{"internalType":"uint256","name":"totalInvested","type":"uint256"},{"internalType":"uint256","name":"received","type":"uint256"},{"internalType":"uint256","name":"rolloverDeposited","type":"uint256"}],"internalType":"struct IPairVault.Asset[]","name":"assets","type":"tuple[]"},{"internalType":"contract IStrategy","name":"strategy","type":"address"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"strategist","type":"address"},{"internalType":"address","name":"rollover","type":"address"},{"internalType":"uint256","name":"hurdleRate","type":"uint256"},{"internalType":"enum OLib.State","name":"state","type":"uint8"},{"internalType":"uint256","name":"startAt","type":"uint256"},{"internalType":"uint256","name":"investAt","type":"uint256"},{"internalType":"uint256","name":"redeemAt","type":"uint256"}],"internalType":"struct IPairVault.VaultView[]","name":"vaults","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_shares","type":"uint256"}],"name":"getWithdrawLp","outputs":[{"internalType":"uint256","name":"seniorTokensNeeded","type":"uint256"},{"internalType":"uint256","name":"juniorTokensNeeded","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_seniorMinIn","type":"uint256"},{"internalType":"uint256","name":"_juniorMinIn","type":"uint256"}],"name":"invest","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_seniorMinReceived","type":"uint256"},{"internalType":"uint256","name":"_juniorMinReceived","type":"uint256"}],"name":"redeem","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"registry","outputs":[{"internalType":"contract IRegistry","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"_tokens","type":"address[]"},{"internalType":"uint256[]","name":"_amounts","type":"uint256[]"}],"name":"rescueTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_rolloverId","type":"uint256"}],"name":"rolloverClaim","outputs":[{"internalType":"uint256","name":"srRollInv","type":"uint256"},{"internalType":"uint256","name":"jrRollInv","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"}],"name":"seniorExpected","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"address","name":"_rollover","type":"address"},{"internalType":"uint256","name":"_rolloverId","type":"uint256"}],"name":"setRollover","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"trancheTokenImpl","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"vaultInvestor","outputs":[{"internalType":"uint256","name":"position","type":"uint256"},{"internalType":"uint256","name":"claimableBalance","type":"uint256"},{"internalType":"uint256","name":"withdrawableExcess","type":"uint256"},{"internalType":"uint256","name":"withdrawableBalance","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"withdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"enum OLib.Tranche","name":"_tranche","type":"uint8"}],"name":"withdrawETH","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_vaultId","type":"uint256"},{"internalType":"uint256","name":"_shares","type":"uint256"}],"name":"withdrawLp","outputs":[{"internalType":"uint256","name":"seniorTokensNeeded","type":"uint256"},{"internalType":"uint256","name":"juniorTokensNeeded","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]`
)

func TestABI_newABI(t *testing.T) {
	newABI, err := abi.NewABI(AllPariVaultAbi)
	assert.NoError(t, err)
	t.Log(newABI)
	methods := newABI.MethodsBySignature
	for k, v := range methods {
		t.Log("k", k, "name", v.Name, "id", v.HexID())
	}

	for k, v := range newABI.EventsBySignature {
		t.Log("k", k, "name", v.Name, "id", v.ID())
	}
}
